<!DOCTYPE html>
<html>
<head>
  <base target="_top" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SCMC HOSCAD/EMS TRACKING</title>
  <style>
    :root{
      --bg:#070a0f;
      --panel:#0c111a;
      --panel2:#0a0f17;
      --line:#1f2b3d;
      --text:#d9e3f2;
      --muted:#8fa1b8;
      --hi:#ffffff;
      --blue:#2f6cff;
      --yellow:#ffd66b;
      --red:#ff6b6b;
      --purple:#c084fc;
      --green:#7fffb2;
      --gray:#a8b3c2;
    }
    html, body { height: 100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: Consolas, Menlo, Monaco, "Courier New", monospace;
      letter-spacing:.3px;
      text-transform: uppercase;
    }
    input, select, button, textarea { text-transform: uppercase; font-family: inherit; letter-spacing:.3px; }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(7,10,15,.97);
      border-bottom:2px solid var(--line);
    }
    .topbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      padding:10px 12px;
    }
    .brand{
      font-weight:900;
      color:var(--hi);
      padding:6px 10px;
      border:2px solid var(--line);
      background:var(--panel2);
    }
    .pill{
      padding:6px 10px;
      border:2px solid var(--line);
      background:var(--panel2);
      color:var(--muted);
      font-size:12px;
    }
    .pill.live { color:var(--green); border-color:#214434; }
    .pill.offline { color:#ff9e9e; border-color:#5b2727; }
    .msgBadge{
      padding:6px 10px;
      border:2px solid var(--line);
      background:var(--panel2);
      color:var(--yellow);
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .msgBadge:hover{ filter:brightness(1.2); }
    .msgBadge.hasUrgent{ 
      color:var(--red); 
      border-color:#5b2727;
      animation: pulseBadge 1.5s infinite;
    }
    @keyframes pulseBadge{
      0%, 100% { opacity:1; }
      50% { opacity:.6; }
    }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .right{ margin-left:auto; }
    input, select, button, textarea{
      background:var(--panel);
      color:var(--text);
      border:2px solid var(--line);
      padding:10px 12px;
      font-size:13px;
      outline:none;
    }
    textarea{ min-height:84px; resize:vertical; }
    input::placeholder, textarea::placeholder{ color:#657892; }
    button{ cursor:pointer; }
    button:hover{ filter:brightness(1.08); }
    .btn-secondary{ background:var(--panel2); }
    .btn-good{ background:#0f2518; border-color:#214434; }
    .btn-danger{ background:#2a1212; border-color:#5b2727; }
    .wrap{ padding:12px; padding-bottom: 104px; }
    .grid{ display:grid; grid-template-columns: 1.3fr .7fr; gap:12px; }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }
    .card{
      background:var(--panel2);
      border:2px solid var(--line);
      padding:10px;
    }
    .card h3{
      margin:0 0 10px 0;
      font-size:13px;
      color:var(--hi);
      border-bottom:2px solid var(--line);
      padding-bottom:8px;
    }
    .banner{
      margin: 0 12px 10px 12px;
      padding:10px 12px;
      border:2px solid var(--line);
      background: #0b1018;
      color: var(--hi);
    }
    .banner.note{
      border-color:#6a5220;
      background: rgba(255,214,107,.10);
      color: var(--yellow);
      font-weight:900;
    }
    .banner.alert{
      border-color:#5b2727;
      background: rgba(255,107,107,.12);
      color: #ffb0b0;
      font-weight:900;
    }
    .table{ width:100%; border-collapse: collapse; font-size:12px; }
    .table th, .table td{
      border-bottom:2px solid var(--line);
      padding:4px 6px;
      vertical-align:top;
    }
    .table th{ color:var(--muted); font-weight:900; font-size:11px; }
    .unit{ font-weight:900; color:var(--hi); }
    .muted{ color:var(--muted); font-size:12px; }
    .destBig{
      font-weight:900;
      color: var(--hi);
      font-size:12px;
      padding:1px 0;
      line-height:1.1;
    }
    .noteBig{
      font-weight:800;
      color: var(--yellow);
      font-size:11px;
      line-height:1.1;
      padding-top:1px;
      white-space:pre-wrap;
      word-break: break-word;
    }
    .statusPill{
      border:2px solid var(--line);
      background: #0b1018;
      padding:4px 6px;
      display:inline-block;
      min-width: 150px;
      font-size:11px;
    }
    .statusTop{ font-weight:900; font-size:11px; line-height:1.2; }
    .statusMeta{ color:var(--muted); font-size:10px; padding-top:1px; line-height:1.1; }
    .S-D{ border-color: var(--blue); }
    .S-DE{ border-color: var(--yellow); }
    .S-OS{ border-color: var(--red); }
    .S-F{ border-color: #c83232; }
    .S-FD{ border-color: #ffa500; }
    .S-T{ border-color: var(--purple); }
    .S-AV{ border-color: var(--green); }
    .S-UV{ border-color: var(--gray); }
    .S-BRK{ border-color: #ffd700; }
    .S-OOS{ border-color: var(--gray); }
    .statusPill.S-D{
      background: rgba(47,108,255,.14);
      animation: flashBlue 1.1s infinite alternate;
    }
    @keyframes flashBlue{
      from { filter: brightness(1.25); }
      to   { filter: brightness(.65); }
    }
    tr.stale10 td{ outline:2px solid rgba(255,214,107,.25); outline-offset:-3px; }
    tr.stale20 td{ outline:2px solid rgba(255,214,107,.55); outline-offset:-3px; }
    tr.stale30 td{ outline:2px solid rgba(255,107,107,.75); outline-offset:-3px; }
    
    /* Status row color tints */
    tr.status-D { background: rgba(47,108,255,.08); }
    tr.status-DE { background: rgba(255,214,107,.08); }
    tr.status-OS { background: rgba(255,107,107,.08); }
    tr.status-F { background: rgba(200,50,50,.08); }
    tr.status-FD { background: rgba(255,165,0,.08); }
    tr.status-T { background: rgba(192,132,252,.08); }
    tr.status-AV { background: rgba(127,255,178,.05); }
    tr.status-UV { background: rgba(168,179,194,.08); }
    tr.status-BRK { background: rgba(255,215,0,.08); }
    tr.status-OOS { background: rgba(168,179,194,.08); }
    
    /* Stale unit pulsing effect */
    tr.stale30 {
      animation: stalePulse 2s infinite;
    }
    @keyframes stalePulse{
      0%, 100% { background-color: rgba(255,107,107,.12); }
      50% { background-color: rgba(255,107,107,.06); }
    }
    .actions{ display:flex; gap:6px; flex-wrap:wrap; }
    .mini{
      padding:8px 10px;
      border-width:2px;
      font-size:12px;
      font-weight:900;
      background: #0b1018;
    }
    .modalBack, .loginBack{
      position:fixed; inset:0; background:rgba(0,0,0,.75);
      display:none; align-items:center; justify-content:center; z-index:30;
      padding:12px;
    }
    .modal{
      width:min(780px, 100%);
      max-height: 90vh;
      overflow-y: auto;
      background:var(--panel2);
      border:2px solid var(--line);
      padding:12px;
    }
    .modal h2{ margin:0 0 10px 0; font-size:14px; }
    .modal .row{ margin:10px 0; }
    .loginBack{ display:flex; background:rgba(0,0,0,.75); }
    .login{ width:min(440px, 100%); }
    .cmdbar{
      position:fixed; left:0; right:0; bottom:0;
      background:rgba(7,10,15,.98);
      border-top:2px solid var(--line);
      padding:10px 12px;
      z-index:40;
    }
    .cmdhint{ margin-top:6px; color:var(--muted); font-size:12px; }
    .twoCol{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width: 900px){ .twoCol{ grid-template-columns:1fr; } }
    .incidentIdLink{
      cursor:pointer;
      text-decoration: underline;
      text-underline-offset: 3px;
      font-weight:900;
      color: var(--hi);
    }
    .incidentIdLink:hover{ color:var(--yellow); }
    
    .clickableUnitId{
      cursor:pointer;
      user-select:none;
    }
    .clickableUnitId:hover{ color:var(--yellow); }
    
    .clickableIncidentNum{
      cursor:pointer;
      text-decoration: underline;
      text-underline-offset: 2px;
      user-select:none;
    }
    .clickableIncidentNum:hover{ color:var(--yellow); }
    #uhBack .modal { width: min(980px, 100%); }
    .uhTable { width:100%; border-collapse: collapse; font-size:13px; }
    .uhTable th, .uhTable td{
      border-bottom:2px solid var(--line);
      padding:10px 8px;
      vertical-align:top;
    }
    .uhTable th{ color:var(--muted); font-weight:900; font-size:12px; }
    .uhLine { color: var(--muted); font-size:12px; margin-top:8px; }
    .msgModal .msgList{ max-height:400px; overflow-y:auto; }
    .msgItem{
      padding:10px;
      border-bottom:2px solid var(--line);
      cursor:pointer;
      transition:.15s background;
    }
    .msgItem:hover{ background:rgba(255,255,255,.03); }
    .msgItem.unread{ background:rgba(47,108,255,.08); }
    .msgItem.urgent{ background:rgba(255,107,107,.12); border-color:#5b2727; }
    .msgHeader{ display:flex; justify-content:space-between; margin-bottom:4px; }
    .msgFrom{ font-weight:900; color:var(--hi); }
    .msgTime{ color:var(--muted); font-size:11px; }
    .msgText{ color:var(--text); font-size:12px; line-height:1.3; }
    .msgUrgent{ color:var(--red); font-weight:900; font-size:11px; }
    .roleColor-STA1{ color:#3b82f6; }
    .roleColor-STA2{ color:#8b5cf6; }
    .roleColor-STA3{ color:#ec4899; }
    .roleColor-STA4{ color:#f59e0b; }
    .roleColor-STA5{ color:#10b981; }
    .roleColor-STA6{ color:#06b6d4; }
    .roleColor-SUPV{ color:#fbbf24; }
    .roleColor-EMS{ color:#22c55e; }
    .roleColor-MSC{ color:#a78bfa; }
    
    /* Messages display in main panel */
    .messagesPanel{
      max-height: 300px;
      overflow-y: auto;
    }
    
    .incidentQueue{
      max-height: 180px;
      overflow-y: auto;
      margin-top: 8px;
    }
    
    .queuedIncident{
      background: var(--panel);
      border: 2px solid var(--line);
      padding: 8px 10px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    .queuedIncident:hover{
      border-color: var(--yellow);
    }
    .queuedIncident.urgent{
      border-color: var(--red);
      animation: pulseQueue 1.5s infinite;
    }
    @keyframes pulseQueue{
      0%, 100% { border-color: var(--red); }
      50% { border-color: rgba(255,107,107,0.4); }
    }
    .queuedIncidentHeader{
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .queuedIncidentId{
      font-weight: 900;
      color: var(--yellow);
      font-size: 13px;
    }
    .queuedIncidentTime{
      color: var(--muted);
      font-size: 11px;
    }
    .queuedIncidentDest{
      color: var(--hi);
      font-size: 12px;
      margin-bottom: 4px;
    }
    .queuedIncidentNote{
      color: var(--text);
      font-size: 11px;
      line-height: 1.3;
    }
    .messageDisplayItem{
      padding:10px;
      margin-bottom:8px;
      border:2px solid var(--line);
      background: #0b1018;
    }
    .messageDisplayItem.urgent{
      border-color:#5b2727;
      background: rgba(255,107,107,.12);
      animation: pulseBadge 1.5s infinite;
    }
    .messageDisplayHeader{
      font-weight:900;
      color:var(--yellow);
      margin-bottom:4px;
      font-size:12px;
    }
    .messageDisplayItem.urgent .messageDisplayHeader{
      color:var(--red);
    }
    .messageDisplayText{
      color:var(--text);
      font-size:12px;
      line-height:1.3;
    }
    .messageDisplayTime{
      color:var(--muted);
      font-size:11px;
      margin-top:4px;
    }
    
    /* Confirm dialog styles */
    .confirmDialog{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.80);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .confirmDialog.active{
      display:flex;
    }
    .confirmBox{
      background:var(--panel2);
      border:2px solid var(--line);
      padding:20px;
      max-width:500px;
      width:90%;
      max-height:80vh;
      overflow-y:auto;
    }
    .confirmTitle{
      font-size:14px;
      font-weight:900;
      color:var(--hi);
      margin-bottom:12px;
    }
    .confirmMessage{
      color:var(--text);
      margin-bottom:16px;
      line-height:1.4;
      white-space:pre-wrap;
      font-family: Consolas, Menlo, Monaco, "Courier New", monospace;
      font-size:12px;
    }
    .confirmButtons{
      display:flex;
      gap:10px;
    }
  </style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="brand">SCMC HOSCAD/EMS TRACKING</div>
    <div id="livePill" class="pill">‚Ä¶</div>
    <div class="pill">USER: <span id="userLabel">‚Äî</span></div>
    <div id="msgBadge" class="msgBadge" onclick="openMessages()" style="display:none;">üì© (<span id="msgCount">0</span>)</div>
    <div class="row right">
      <input id="search" placeholder="SEARCH UNIT / NOTE" />
      <label class="pill" style="display:flex;gap:8px;align-items:center;">
        <input id="showInactive" type="checkbox" style="width:16px;height:16px;" />
        SHOW INACTIVE
      </label>
      <button class="btn-secondary" onclick="openLogon()">LOGON</button>
      <button class="btn-secondary" onclick="refresh()">REFRESH</button>
    </div>
  </div>
  <div id="alertBanner" class="banner alert" style="display:none;"></div>
  <div id="noteBanner" class="banner note" style="display:none;"></div>
</header>
<div class="wrap">
  <div id="staleBanner" class="banner alert" style="display:none; margin-bottom:10px;"></div>
  <div class="grid">
    <div class="card">
      <h3>BOARD</h3>
      <div style="overflow:auto;">
        <table class="table">
          <thead>
            <tr>
              <th>UNIT</th>
              <th>STATUS</th>
              <th>DEST / NOTE</th>
              <th>UPDATED</th>
              <th>ACTIONS</th>
            </tr>
          </thead>
          <tbody id="boardBody"></tbody>
        </table>
      </div>
    </div>
    <div class="card">
      <h3>INCIDENT QUEUE <button class="btn-good mini" style="float:right; margin-top:-4px;" onclick="openNewIncident()">+ NEW</button></h3>
      <div id="incidentQueue" class="incidentQueue"></div>
      <div style="height:12px"></div>
      <h3>MESSAGES <span class="muted" style="font-size:11px;" id="msgPanelCount"></span></h3>
      <div id="messagesPanel" class="messagesPanel"></div>
      <div style="height:12px"></div>
      <h3>SHIFT EXPORT</h3>
      <div class="actions">
        <button class="btn-secondary mini" onclick="exportCsv(12)">EXPORT 12H CSV</button>
        <button class="btn-secondary mini" onclick="exportCsv(24)">EXPORT 24H CSV</button>
      </div>
      <div style="height:12px"></div>
      <h3>METRICS (LAST <span id="metricWindow">24</span>H)</h3>
      <div id="metrics" class="muted">‚Äî</div>
      <div style="height:10px"></div>
      <div class="actions">
        <button class="btn-secondary mini" onclick="loadMetrics(12)">12H</button>
        <button class="btn-secondary mini" onclick="loadMetrics(24)">24H</button>
      </div>
    </div>
  </div>
</div>
<div id="loginBack" class="loginBack">
  <div class="card login">
    <h3 style="margin-top:0;">LOGIN</h3>
    <div class="muted" style="margin-bottom:10px;">SELECT ROLE, ENTER USERNAME & PASSWORD</div>
    <div class="row">
      <select id="loginRole" style="flex:1">
        <option value="">SELECT ROLE...</option>
        <option value="STA1">STA1</option>
        <option value="STA2">STA2</option>
        <option value="STA3">STA3</option>
        <option value="STA4">STA4</option>
        <option value="STA5">STA5</option>
        <option value="STA6">STA6</option>
        <option value="SUPV1">SUPV1</option>
        <option value="SUPV2">SUPV2</option>
        <option value="EMS">EMS</option>
        <option value="MSC">MSC</option>
        <option value="UNIT">UNIT (FIELD UNIT)</option>
      </select>
    </div>
    <div class="row">
      <input id="loginUsername" placeholder="USERNAME (OR UNIT ID IF UNIT ROLE)" maxlength="30" style="flex:1" />
    </div>
    <div class="row" id="loginPasswordRow">
      <input id="loginPassword" type="password" placeholder="PASSWORD" maxlength="50" style="flex:1" />
    </div>
    <div class="row">
      <button class="btn-good" onclick="login()">ENTER</button>
      <button class="btn-secondary" onclick="clearSavedToken()">CLEAR TOKEN</button>
      <div id="loginErr" class="muted"></div>
    </div>
  </div>
</div>
<div id="modalBack" class="modalBack">
  <div class="modal">
    <h2 id="modalTitle">EDIT UNIT</h2>
    <div class="twoCol">
      <div>
        <div class="row">
          <input id="mUnitId" placeholder="UNIT (E.G. EMS1 / JC / ADVMED CC)" style="flex:1" />
          <input id="mDisplayName" placeholder="DISPLAY NAME (OPTIONAL)" style="flex:1" />
        </div>
        <div class="row">
          <select id="mStatus" style="flex:1"></select>
          <input id="mDestination" list="destList" placeholder="DESTINATION (FREE TYPE)" style="flex:1" />
          <datalist id="destList"></datalist>
        </div>
        <div class="row">
          <input id="mIncident" placeholder="INCIDENT (BLANK = AUTO ON D)" style="flex:1" />
          <input id="mType" placeholder="TYPE (OPTIONAL)" style="flex:1" />
        </div>
        <div class="row">
          <input id="mNote" placeholder="STATUS NOTE (VISIBLE ON BOARD)" style="flex:1" />
        </div>
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px;">UNIT INFO (NOT SHOWN ON BOARD)</div>
        <textarea id="mUnitInfo" placeholder="PHONE #, CONTACT, SPECIAL NOTES, ETC."></textarea>
      </div>
    </div>
    <div class="row">
      <button class="btn-good" onclick="saveModal()">SAVE</button>
      <button class="btn-secondary" onclick="closeModal()">CANCEL</button>
      <div class="right actions">
        <button class="btn-secondary mini" onclick="confirmRidoff()">RIDOFF</button>
        <button class="btn-danger mini" onclick="confirmLogoff()">LOGOFF</button>
      </div>
    </div>
    <div class="muted" id="modalFoot"></div>
  </div>
</div>
<div id="incBack" class="modalBack">
  <div class="modal">
    <h2 id="incTitle">INCIDENT</h2>
    <div class="row">
      <div class="pill">UNITS: <span id="incUnits">‚Äî</span></div>
      <div class="pill">DEST: <span id="incDest">‚Äî</span></div>
      <div class="pill">UPDATED: <span id="incUpdated">‚Äî</span></div>
      <div class="pill">BY: <span id="incBy">‚Äî</span></div>
    </div>
    <div class="muted" style="margin-top:10px;margin-bottom:6px;">INCIDENT NOTE</div>
    <textarea id="incNote" placeholder="E.G. PT IN WTG RM"></textarea>
    <div class="muted" style="margin-top:10px;margin-bottom:6px;">INCIDENT HISTORY (MOST RECENT LAST)</div>
    <div id="incAudit" class="card" style="max-height: 260px; overflow-y: auto; overflow-x: hidden; background: #0b1018; padding: 6px;"></div>
    <div class="row">
      <button class="btn-good" onclick="saveIncidentNote()">SAVE NOTE</button>
      <button class="btn-secondary" onclick="closeIncident()">CLOSE</button>
    </div>
    <div class="muted">COMMANDS: R 0001 (REVIEW) ‚Ä¢ U 0001; MESSAGE (ADD NOTE) ‚Ä¢ OK INC0001 (TOUCH)</div>
  </div>
</div>
<div id="uhBack" class="modalBack">
  <div class="modal">
    <h2 id="uhTitle">UNIT HISTORY</h2>
    <div class="row">
      <div class="pill">UNIT: <span id="uhUnit">‚Äî</span></div>
      <div class="pill">WINDOW:
        <select id="uhHours" style="padding:8px 10px; font-size:12px;">
          <option value="6">6H</option>
          <option value="12" selected>12H</option>
          <option value="24">24H</option>
          <option value="48">48H</option>
          <option value="72">72H</option>
          <option value="168">7D</option>
        </select>
      </div>
      <div class="right actions">
        <button class="btn-secondary mini" onclick="reloadUH()">RELOAD</button>
        <button class="btn-secondary mini" onclick="closeUH()">CLOSE</button>
      </div>
    </div>
    <div style="overflow:auto; border:2px solid var(--line); background:#0b1018; max-height:400px;">
      <table class="uhTable">
        <thead>
          <tr>
            <th>TIME</th>
            <th>ACTION</th>
            <th>STATUS</th>
            <th>NOTE</th>
            <th>INC</th>
            <th>DEST</th>
            <th>BY</th>
          </tr>
        </thead>
        <tbody id="uhBody">
          <tr><td colspan="7" class="muted">LOAD HISTORY‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>
    <div class="uhLine">COMMANDS: <b>UH EMS1 24</b> OR <b>EMS1 UH 24</b></div>
  </div>
</div>
<div id="newIncBack" class="modalBack">
  <div class="modal">
    <h2>CREATE NEW INCIDENT</h2>
    <div class="row">
      <input id="newIncDest" list="destList" placeholder="DESTINATION (REQUIRED)" style="flex:1" />
    </div>
    <div class="row">
      <select id="newIncUnit" style="flex:1">
        <option value="">ASSIGN UNIT (OPTIONAL)</option>
      </select>
    </div>
    <div class="muted" style="margin-top:10px;margin-bottom:6px;">INCIDENT NOTE (OPTIONAL)</div>
    <textarea id="newIncNote" placeholder="E.G. 67 YOF C/O CHEST PAIN"></textarea>
    <div class="row">
      <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
        <input type="checkbox" id="newIncUrgent" />
        <span>MARK AS URGENT (PRIORITY)</span>
      </label>
    </div>
    <div class="row" style="margin-top:10px;">
      <button class="btn-good" onclick="createNewIncident()">CREATE</button>
      <button class="btn-secondary" onclick="closeNewIncident()">CANCEL</button>
    </div>
  </div>
</div>
<div id="msgBack" class="modalBack">
  <div class="modal msgModal">
    <h2>MESSAGES <span class="muted" style="font-size:12px;">(<span id="msgModalCount">0</span>)</span></h2>
    <div class="msgList" id="msgList">
      <div class="muted" style="padding:20px; text-align:center;">NO MESSAGES</div>
    </div>
    <div class="row" style="margin-top:10px;">
      <button class="btn-secondary" onclick="closeMessages()">CLOSE</button>
      <button class="btn-danger mini" onclick="deleteAllMessages()">DEL ALL MSG</button>
    </div>
    <div class="muted" style="margin-top:8px;">
      COMMANDS: MSG STA2; TEXT ‚Ä¢ HTMSG STA3; URGENT ‚Ä¢ MSG1 (OPEN) ‚Ä¢ DEL MSG1 ‚Ä¢ DEL ALL MSG
    </div>
  </div>
</div>

<!-- Confirm Dialog -->
<div id="confirmDialog" class="confirmDialog">
  <div class="confirmBox">
    <div class="confirmTitle" id="confirmTitle">CONFIRM</div>
    <div class="confirmMessage" id="confirmMessage">Are you sure?</div>
    <div class="confirmButtons">
      <button class="btn-good" id="confirmOk">OK</button>
      <button class="btn-secondary" id="confirmClose" style="display:none;">CLOSE</button>
    </div>
  </div>
</div>

<!-- Alert Dialog (info only, just CLOSE button) -->
<div id="alertDialog" class="confirmDialog">
  <div class="confirmBox">
    <div class="confirmTitle" id="alertTitle">INFO</div>
    <div class="confirmMessage" id="alertMessage">Information</div>
    <div class="confirmButtons">
      <button class="btn-secondary" id="alertClose">CLOSE</button>
    </div>
  </div>
</div>

<div class="cmdbar">
  <div class="row">
    <input id="cmd" placeholder="COMMAND...  EX: D JC; MADRAS ED  OR  LUI EMS23" style="flex:1" />
    <button class="btn-good" onclick="runCommand()">RUN</button>
    <button class="btn-secondary" onclick="showHelp()">HELP</button>
  </div>
  <div class="cmdhint">CTRL+K / F1 / F3 FOCUS CMD ‚Ä¢ CTRL+L LOGON ‚Ä¢ UP/DOWN HISTORY ‚Ä¢ CLICK REPLY ON MESSAGES ‚Ä¢ TYPE HELP FOR ALL COMMANDS</div>
</div>
<script>
let TOKEN=localStorage.getItem('ems_token')||'';let ACTOR='';let STATE=null;let ACTIVE_INCIDENT_FILTER='';let POLL=null;
let BASELINED=false;let LAST_MAX_UPDATED_AT='';let LAST_NOTE_TS='';let LAST_ALERT_TS='';let LAST_INCIDENT_TOUCH='';let LAST_MSG_COUNT=0;
let CURRENT_INCIDENT_ID='';let CMD_HISTORY=[];let CMD_INDEX=-1;let SELECTED_UNIT_ID=null;
const UNIT_LABELS={"JC":"JEFFERSON COUNTY FIRE/EMS","CC":"CROOK COUNTY FIRE/EMS","BND":"BEND FIRE/EMS","BDN":"BEND FIRE/EMS","RDM":"REDMOND FIRE/EMS","CRR":"CROOKED RIVER RANCH FIRE/EMS","LP":"LA PINE FIRE/EMS","SIS":"SISTERS FIRE/EMS","AL1":"AIRLINK 1 RW","AL2":"AIRLINK 2 FW","ALG":"AIRLINK GROUND","AL":"AIR RESOURCE","ADVMED":"ADVENTURE MEDICS","ADVMED CC":"ADVENTURE MEDICS CRITICAL CARE"};
function displayNameForUnit(u){const uu=String(u||'').trim().toUpperCase();return UNIT_LABELS[uu]||uu;}
function canonicalUnit(r){if(!r)return'';let u=String(r).trim().toUpperCase().replace(/[^\w\s-]/g,'').replace(/\s+/g,' ').trim();const k=Object.keys(UNIT_LABELS).sort((a,b)=>b.length-a.length);for(const kk of k){if(u===kk)return kk;}return u;}
let audioCtx=null;function _ctx(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();return audioCtx;}
function beep(f,m,w=0){const c=_ctx();const t=c.currentTime+w;const o=c.createOscillator();const g=c.createGain();o.type='sine';o.frequency.value=f;g.gain.setValueAtTime(0.0001,t);g.gain.exponentialRampToValueAtTime(0.2,t+0.01);g.gain.exponentialRampToValueAtTime(0.0001,t+(m/1000));o.connect(g);g.connect(c.destination);o.start(t);o.stop(t+(m/1000)+0.02);}
function beepChange(){try{beep(880,90,0);beep(880,90,0.14);}catch(e){}}
function beepNote(){try{beep(660,90,0);beep(660,90,0.16);}catch(e){}}
function beepAlert(){try{beep(400,1500,0);beep(400,1500,1.7);}catch(e){}}
function beepMessage(){try{beep(600,120,0);}catch(e){}}
function beepHotMessage(){try{beep(900,1800,0);}catch(e){}}

// Confirm dialog functions
let CONFIRM_CALLBACK = null;
function showConfirm(title, message, callback) {
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmMessage').textContent = message;
  CONFIRM_CALLBACK = callback;
  document.getElementById('confirmDialog').classList.add('active');
}
function hideConfirm() {
  document.getElementById('confirmDialog').classList.remove('active');
  CONFIRM_CALLBACK = null;
}
document.getElementById('confirmOk').addEventListener('click', () => {
  hideConfirm();
  if (CONFIRM_CALLBACK) CONFIRM_CALLBACK();
});
document.getElementById('confirmClose').addEventListener('click', () => {
  hideConfirm();
});

// Alert dialog functions (info only, just CLOSE button)
function showAlert(title, message) {
  document.getElementById('alertTitle').textContent = title;
  document.getElementById('alertMessage').textContent = message;
  document.getElementById('alertDialog').classList.add('active');
}
function hideAlert() {
  document.getElementById('alertDialog').classList.remove('active');
}
document.getElementById('alertClose').addEventListener('click', () => {
  hideAlert();
});

function esc(s){return String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");}
function fmtTime24(i){if(!i)return'‚Äî';const d=new Date(i);if(!isFinite(d.getTime()))return'‚Äî';return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});}
function minutesSince(i){if(!i)return null;const t=new Date(i).getTime();if(!isFinite(t))return null;return(Date.now()-t)/60000;}
const STATUS_RANK={D:1,DE:2,OS:3,T:4,AV:5,OOS:6};function statusRank(c){return STATUS_RANK[String(c||'').toUpperCase()]??99;}
function setLive(ok,txt){const e=document.getElementById('livePill');e.className='pill '+(ok?'live':'offline');e.textContent=txt;}
function offline(e){console.error(e);setLive(false,'OFFLINE');}
function clearSavedToken(){localStorage.removeItem('ems_token');TOKEN='';document.getElementById('loginErr').textContent='TOKEN CLEARED.';}
function showErr(r){if(r&&r.conflict){showConfirm('CONFLICT', r.error+'\n\nCURRENT: '+r.current.status+'\nUPDATED: '+r.current.updated_at+'\nBY: '+r.current.updated_by, () => refresh());return;}showAlert('ERROR', r&&r.error?r.error:'UNKNOWN ERROR.');refresh();}
function expandShortcutsInText(t){if(!t)return'';return t.toUpperCase().split(/\b/).map(w=>UNIT_LABELS[w.toUpperCase()]||w).join('');}
function getRoleColor(a){const m=String(a||'').match(/@([A-Z0-9]+)$/);if(!m)return'';return'roleColor-'+m[1];}
function openModal(u,f=false){const b=document.getElementById('modalBack');b.style.display='flex';document.getElementById('mUnitId').value=u?u.unit_id:'';document.getElementById('mDisplayName').value=u?(u.display_name||''):'';document.getElementById('mType').value=u?(u.type||''):'';document.getElementById('mStatus').value=u?u.status:'AV';document.getElementById('mDestination').value=u?(u.destination||''):'';document.getElementById('mIncident').value=u?(u.incident||''):'';document.getElementById('mNote').value=u?(u.note||''):'';document.getElementById('mUnitInfo').value=u?(u.unit_info||''):'';document.getElementById('modalTitle').textContent=u?'EDIT '+u.unit_id:'LOGON UNIT';document.getElementById('modalFoot').textContent=u?'UPDATED: '+(u.updated_at||'‚Äî')+' BY '+(u.updated_by||'‚Äî'):'TIP: SET STATUS TO D WITH INCIDENT BLANK TO AUTO-GENERATE.';b.dataset.expectedUpdatedAt=u?(u.updated_at||''):'';if(f){setTimeout(()=>document.getElementById('mUnitInfo').focus(),50);}}
function closeModal(){const b=document.getElementById('modalBack');b.style.display='none';b.dataset.expectedUpdatedAt='';autoFocusCmd();}
function openLogon(){openModal(null);}
function login(){const r=(document.getElementById('loginRole').value||'').trim().toUpperCase();const u=(document.getElementById('loginUsername').value||'').trim();const p=(document.getElementById('loginPassword').value||'').trim();const e=document.getElementById('loginErr');e.textContent='';if(!r){e.textContent='SELECT ROLE.';return;}if(r==='UNIT'){if(!u||u.length<2){e.textContent='ENTER UNIT ID (E.G. EMS2121, CC1, WC1)';return;}}else{if(!u||u.length<2){e.textContent='ENTER USERNAME';return;}if(!p){e.textContent='ENTER PASSWORD';return;}}google.script.run.withSuccessHandler(res=>{if(!res||!res.ok){e.textContent=(res&&res.error)?res.error:'LOGIN FAILED.';return;}TOKEN=res.token;ACTOR=res.actor;localStorage.setItem('ems_token',TOKEN);document.getElementById('loginBack').style.display='none';document.getElementById('userLabel').textContent=ACTOR;start();}).withFailureHandler(err=>{e.textContent='LOGIN FAILED (SERVER).';offline(err);}).apiLogin(r,u,p);}
function refresh(){if(!TOKEN)return;google.script.run.withSuccessHandler(r=>{STATE=r;if(!STATE||!STATE.ok){setLive(false,'OFFLINE');return;}setLive(true,'LIVE ‚Ä¢ '+fmtTime24(STATE.serverTime));ACTOR=STATE.actor||ACTOR;document.getElementById('userLabel').textContent=ACTOR;tryBeepOnStateChange();renderAll();}).withFailureHandler(e=>offline(e)).apiGetState(TOKEN);}
function exportCsv(h){google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);const b=new Blob([r.csv],{type:'text/csv;charset=utf-8;'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=r.filename;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);}).withFailureHandler(e=>offline(e)).apiExportAuditCsv(TOKEN,h);}
function loadMetrics(h){document.getElementById('metricWindow').textContent=String(h);google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);STATE.metrics=r.metrics;renderMetrics();}).withFailureHandler(e=>offline(e)).apiGetMetrics(TOKEN,h);}
function tryBeepOnStateChange(){let mU='';(STATE.units||[]).forEach(u=>{if(u&&u.updated_at&&(!mU||u.updated_at>mU))mU=u.updated_at;});const nTs=(STATE.banners&&STATE.banners.note&&STATE.banners.note.ts)?STATE.banners.note.ts:'';const aTs=(STATE.banners&&STATE.banners.alert&&STATE.banners.alert.ts)?STATE.banners.alert.ts:'';let mI='';(STATE.incidents||[]).forEach(i=>{if(i&&i.last_update&&(!mI||i.last_update>mI))mI=i.last_update;});const mC=(STATE.messages||[]).length;const uC=(STATE.messages||[]).filter(m=>!m.read).length;const uU=(STATE.messages||[]).filter(m=>m.urgent&&!m.read).length;if(!BASELINED){BASELINED=true;LAST_MAX_UPDATED_AT=mU;LAST_NOTE_TS=nTs;LAST_ALERT_TS=aTs;LAST_INCIDENT_TOUCH=mI;LAST_MSG_COUNT=mC;return;}if(aTs&&aTs!==LAST_ALERT_TS){LAST_ALERT_TS=aTs;beepAlert();}if(nTs&&nTs!==LAST_NOTE_TS){LAST_NOTE_TS=nTs;beepNote();}if(mC>LAST_MSG_COUNT){LAST_MSG_COUNT=mC;if(uU>0)beepHotMessage();else beepMessage();}if(mI&&mI!==LAST_INCIDENT_TOUCH){LAST_INCIDENT_TOUCH=mI;beepChange();}if(mU&&mU!==LAST_MAX_UPDATED_AT){LAST_MAX_UPDATED_AT=mU;beepChange();}}
function renderAll(){if(!STATE)return;const sS=document.getElementById('mStatus');if(!sS.options.length){(STATE.statuses||[]).forEach(s=>{const o=document.createElement('option');o.value=s.code;o.textContent=s.code+' ‚Äî '+s.label;sS.appendChild(o);});}const dL=document.getElementById('destList');dL.innerHTML='';(STATE.destinations||[]).forEach(d=>{const a=document.createElement('option');a.value=d.code;dL.appendChild(a);if(d.name&&d.name!==d.code){const b=document.createElement('option');b.value=d.name;dL.appendChild(b);}});renderBanners();renderIncidentQueue();renderMessagesPanel();renderMessages();renderMetrics();renderBoard();}
function renderBanners(){const a=document.getElementById('alertBanner');const n=document.getElementById('noteBanner');const b=(STATE&&STATE.banners)?STATE.banners:{alert:null,note:null};if(b.alert&&b.alert.message){a.style.display='block';a.textContent='ALERT: '+b.alert.message+' ‚Äî '+(b.alert.actor||'');}else a.style.display='none';if(b.note&&b.note.message){n.style.display='block';n.textContent='NOTE: '+b.note.message+' ‚Äî '+(b.note.actor||'');}else n.style.display='none';}
function renderMessages(){const m=STATE.messages||[];const u=m.filter(mm=>!mm.read).length;const uu=m.filter(mm=>mm.urgent&&!mm.read).length;const b=document.getElementById('msgBadge');const c=document.getElementById('msgCount');if(u>0){b.style.display='inline-block';c.textContent=u;if(uu>0){b.classList.add('hasUrgent');}else{b.classList.remove('hasUrgent');}}else{b.style.display='none';}}

function autoFocusCmd(){setTimeout(()=>document.getElementById('cmd').focus(),100);}

function renderIncidentQueue(){
  const panel=document.getElementById('incidentQueue');
  const incidents=(STATE.incidents||[]).filter(i=>i.status==='QUEUED');
  if(!incidents.length){
    panel.innerHTML='<div class="muted" style="padding:20px;text-align:center;">NO QUEUED INCIDENTS</div>';
    return;
  }
  
  incidents.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
  
  panel.innerHTML=incidents.map(inc=>{
    const urgent=inc.incident_note&&inc.incident_note.includes('[URGENT]');
    const cl=['queuedIncident'];
    if(urgent)cl.push('urgent');
    const mins=minutesSince(inc.created_at);
    const age=mins!=null?Math.floor(mins)+'M AGO':'';
    const shortId=inc.incident_id.replace(/^\d{2}-/,'');
    let note=(inc.incident_note||'').replace(/^\[URGENT\]\s*/i,'').trim();
    // Filter out timestamp garbage (looks like "MON JAN 26..." or contains "GMT")
    if(note.match(/^(MON|TUE|WED|THU|FRI|SAT|SUN)\s+/i)||note.includes('GMT')||note.includes('PACIFIC')){
      note='';
    }
    return `
      <div class="${cl.join(' ')}" onclick="assignIncidentToUnit('${esc(inc.incident_id)}')">
        <div class="queuedIncidentHeader">
          <span class="queuedIncidentId">${urgent?'üî• ':''}INC${esc(shortId)}</span>
          <span class="queuedIncidentTime">${age}</span>
        </div>
        <div class="queuedIncidentDest">üìç ${esc(inc.destination||'NO DEST')}</div>
        ${note?`<div class="queuedIncidentNote">${esc(note)}</div>`:''}
      </div>
    `;
  }).join('');
}

function openNewIncident(){
  const unitSelect=document.getElementById('newIncUnit');
  unitSelect.innerHTML='<option value="">ASSIGN UNIT (OPTIONAL)</option>';
  
  const units=(STATE.units||[]).filter(u=>u.active&&u.status==='AV');
  units.forEach(u=>{
    const opt=document.createElement('option');
    opt.value=u.unit_id;
    opt.textContent=u.unit_id+(u.display_name&&u.display_name!==u.unit_id?' - '+u.display_name:'');
    unitSelect.appendChild(opt);
  });
  
  document.getElementById('newIncDest').value='';
  document.getElementById('newIncNote').value='';
  document.getElementById('newIncUrgent').checked=false;
  document.getElementById('newIncBack').style.display='flex';
  setTimeout(()=>document.getElementById('newIncDest').focus(),50);
}

function closeNewIncident(){
  document.getElementById('newIncBack').style.display='none';
  autoFocusCmd();
}

function createNewIncident(){
  const dest=document.getElementById('newIncDest').value.trim().toUpperCase();
  const note=document.getElementById('newIncNote').value.trim().toUpperCase();
  const urgent=document.getElementById('newIncUrgent').checked;
  const unitId=document.getElementById('newIncUnit').value;
  
  if(!dest){
    showAlert('ERROR','DESTINATION REQUIRED.');
    return;
  }
  
  const finalNote=(urgent&&note?'[URGENT] '+note:(urgent?'[URGENT]':note));
  
  setLive(true,'LIVE ‚Ä¢ CREATE INCIDENT');
  google.script.run.withSuccessHandler(r=>{
    if(!r.ok)return showErr(r);
    beepChange();
    if(r.urgent)beepAlert();
    closeNewIncident();
    refresh();
  }).withFailureHandler(e=>offline(e)).apiCreateQueuedIncident(TOKEN,dest,finalNote,urgent,unitId);
}

function assignIncidentToUnit(incidentId){
  const input=document.createElement('input');
  input.type='text';
  input.placeholder='UNIT ID (E.G. EMS1, WC1)';
  input.style.cssText='width:100%;padding:10px;background:var(--panel);color:var(--text);border:2px solid var(--line);font-family:inherit;text-transform:uppercase;font-size:14px;margin-top:10px;';
  
  const shortId=incidentId.replace(/^\d{2}-/,'');
  
  const message=document.createElement('div');
  message.innerHTML='ASSIGN INC'+esc(shortId)+' TO UNIT:';
  message.appendChild(input);
  
  document.getElementById('alertTitle').textContent='ASSIGN INCIDENT';
  document.getElementById('alertMessage').innerHTML='';
  document.getElementById('alertMessage').appendChild(message);
  document.getElementById('alertDialog').classList.add('active');
  
  setTimeout(()=>input.focus(),100);
  
  const handleAssign=()=>{
    const unitInput=input.value.trim();
    if(!unitInput){
      hideAlert();
      return;
    }
    
    const unitId=canonicalUnit(unitInput);
    if(!unitId){
      showAlert('ERROR','INVALID UNIT ID');
      return;
    }
    
    hideAlert();
    const cmd=`DE ${unitId} ${incidentId}`;
    document.getElementById('cmd').value=cmd;
    runCommand();
  };
  
  input.addEventListener('keydown',(e)=>{
    if(e.key==='Enter'){
      handleAssign();
    }else if(e.key==='Escape'){
      hideAlert();
    }
  });
  
  const oldCloseHandler=document.getElementById('alertClose').onclick;
  document.getElementById('alertClose').onclick=()=>{
    hideAlert();
    document.getElementById('alertClose').onclick=oldCloseHandler;
  };
}

function renderMessagesPanel(){const panel=document.getElementById('messagesPanel');const m=STATE.messages||[];const unread=m.filter(msg=>!msg.read).length;const countEl=document.getElementById('msgPanelCount');if(countEl){countEl.textContent=m.length>0?`(${m.length} TOTAL, ${unread} UNREAD)`:'';}if(!m.length){panel.innerHTML='<div class="muted" style="padding:20px;text-align:center;">NO MESSAGES</div>';return;}panel.innerHTML=m.map(msg=>{const cl=['messageDisplayItem'];if(msg.urgent)cl.push('urgent');const fr=msg.from_initials+'@'+msg.from_role;const fC=getRoleColor(fr);const uH=msg.urgent?'[HOT] ':'';const replyCmd='MSG '+msg.from_role+'; ';return'<div class="'+cl.join(' ')+'"><div class="messageDisplayHeader '+fC+'">'+uH+esc(msg.message_id)+' ‚Ä¢ FROM '+esc(fr)+' TO '+esc(msg.to_role)+'</div><div class="messageDisplayText">'+esc(msg.message)+'</div><div class="messageDisplayTime">'+fmtTime24(msg.ts)+'<button class="btn-secondary mini" style="margin-left:10px;" onclick="replyToMessage(\''+esc(replyCmd)+'\')">REPLY</button></div></div>';}).join('');}
function replyToMessage(cmd){document.getElementById('cmd').value=cmd;document.getElementById('cmd').focus();}

function confirmLogoff(){const uId=canonicalUnit(document.getElementById('mUnitId').value);if(!uId)return;const eUA=document.getElementById('modalBack').dataset.expectedUpdatedAt||'';const currentStatus=document.getElementById('mStatus').value;const needsConfirm=['OS','T','D','DE'].includes(currentStatus);if(needsConfirm){showConfirm('CONFIRM LOGOFF', 'LOGOFF '+uId+' (CURRENTLY '+currentStatus+')?', () => {setLive(true,'LIVE ‚Ä¢ LOGOFF');google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);beepChange();closeModal();refresh();}).withFailureHandler(e=>offline(e)).apiLogoffUnit(TOKEN,uId,eUA);});}else{setLive(true,'LIVE ‚Ä¢ LOGOFF');google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);beepChange();closeModal();refresh();}).withFailureHandler(e=>offline(e)).apiLogoffUnit(TOKEN,uId,eUA);}}
function confirmRidoff(){const uId=canonicalUnit(document.getElementById('mUnitId').value);if(!uId)return;const eUA=document.getElementById('modalBack').dataset.expectedUpdatedAt||'';showConfirm('CONFIRM RIDOFF', 'RIDOFF '+uId+'? (SETS AV + CLEARS NOTE/INCIDENT/DEST)', () => {setLive(true,'LIVE ‚Ä¢ RIDOFF');google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);beepChange();closeModal();refresh();}).withFailureHandler(e=>offline(e)).apiRidoffUnit(TOKEN,uId,eUA);});}
function saveModal(){let uId=canonicalUnit(document.getElementById('mUnitId').value);if(!uId){showConfirm('ERROR','UNIT REQUIRED.',()=>{});return;}let dN=(document.getElementById('mDisplayName').value||'').trim().toUpperCase();if(!dN)dN=displayNameForUnit(uId);const p={displayName:dN,type:(document.getElementById('mType').value||'').trim().toUpperCase(),status:document.getElementById('mStatus').value,destination:(document.getElementById('mDestination').value||'').trim().toUpperCase(),incident:(document.getElementById('mIncident').value||'').trim().toUpperCase(),note:(document.getElementById('mNote').value||'').toUpperCase(),unitInfo:(document.getElementById('mUnitInfo').value||'').toUpperCase(),active:true};const eUA=document.getElementById('modalBack').dataset.expectedUpdatedAt||'';setLive(true,'LIVE ‚Ä¢ SAVING');google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);beepChange();closeModal();refresh();}).withFailureHandler(e=>offline(e)).apiUpsertUnit(TOKEN,uId,p,eUA);}
function quickStatus(u,c){const msg='SET '+u.unit_id+' ‚Üí '+c+'?'+(c==='AV'&&(u.incident||u.destination||u.note)?'\n\nNOTE: AV CLEARS INCIDENT.':'');showConfirm('CONFIRM STATUS CHANGE', msg, () => {setLive(true,'LIVE ‚Ä¢ UPDATE');google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);beepChange();refresh();autoFocusCmd();}).withFailureHandler(e=>offline(e)).apiUpsertUnit(TOKEN,u.unit_id,{status:c,displayName:u.display_name},u.updated_at||'');});}
function undoUnit(uId){showConfirm('CONFIRM UNDO', 'UNDO LAST ACTION FOR '+uId+'?', () => {setLive(true,'LIVE ‚Ä¢ UNDO');google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);beepChange();refresh();autoFocusCmd();}).withFailureHandler(e=>offline(e)).apiUndoUnit(TOKEN,uId);});}
function okUnit(u){if(!u||!u.unit_id)return;setLive(true,'LIVE ‚Ä¢ OK');google.script.run.withSuccessHandler(r=>{if(!r||!r.ok)return showErr(r);beepChange();refresh();autoFocusCmd();}).withFailureHandler(e=>offline(e)).apiTouchUnit(TOKEN,u.unit_id,u.updated_at||'');}
function okAllOS(){showConfirm('CONFIRM OKALL', 'OKALL: RESET STATIC TIMER FOR ALL ON SCENE (OS) UNITS?', () => {setLive(true,'LIVE ‚Ä¢ OKALL');google.script.run.withSuccessHandler(r=>{if(!r||!r.ok)return showErr(r);beepChange();refresh();autoFocusCmd();}).withFailureHandler(e=>offline(e)).apiTouchAllOS(TOKEN);});}
let UH_CURRENT_UNIT='';let UH_CURRENT_HOURS=12;
function closeUH(){document.getElementById('uhBack').style.display='none';UH_CURRENT_UNIT='';}
function reloadUH(){if(!UH_CURRENT_UNIT)return;const h=Number(document.getElementById('uhHours').value||12);openHistory(UH_CURRENT_UNIT,h);}
function openHistory(uId,h){if(!TOKEN){showConfirm('ERROR','NOT LOGGED IN.',()=>{});return;}const u=canonicalUnit(uId);if(!u){showConfirm('ERROR','USAGE: UH <UNIT> [HOURS]',()=>{});return;}UH_CURRENT_UNIT=u;UH_CURRENT_HOURS=Number(h||12);document.getElementById('uhTitle').textContent='UNIT HISTORY';document.getElementById('uhUnit').textContent=u;document.getElementById('uhHours').value=String(UH_CURRENT_HOURS);document.getElementById('uhBack').style.display='flex';document.getElementById('uhBody').innerHTML='<tr><td colspan="7" class="muted">LOADING‚Ä¶</td></tr>';setLive(true,'LIVE ‚Ä¢ UNIT HISTORY');google.script.run.withSuccessHandler(r=>{if(!r||!r.ok)return showErr(r);const rs=r.rows||[];if(!rs.length){document.getElementById('uhBody').innerHTML='<tr><td colspan="7" class="muted">NO HISTORY IN THIS WINDOW.</td></tr>';return;}rs.sort((a,b)=>new Date(b.ts||0)-new Date(a.ts||0));document.getElementById('uhBody').innerHTML=rs.map(rr=>{const ts=rr.ts?fmtTime24(rr.ts):'‚Äî';const nx=rr.next||{};const st=String(nx.status||'').toUpperCase();const aC=getRoleColor(rr.actor);return'<tr><td>'+esc(ts)+'</td><td>'+esc((rr.action||'').toUpperCase())+'</td><td>'+esc(st||'‚Äî')+'</td><td>'+(nx.note?esc(String(nx.note||'').toUpperCase()):'<span class="muted">‚Äî</span>')+'</td><td>'+(nx.incident?esc(String(nx.incident||'').toUpperCase()):'<span class="muted">‚Äî</span>')+'</td><td>'+(nx.destination?esc(String(nx.destination||'').toUpperCase()):'<span class="muted">‚Äî</span>')+'</td><td class="muted '+aC+'">'+(rr.actor?esc(String(rr.actor||'').toUpperCase()):'<span class="muted">‚Äî</span>')+'</td></tr>';}).join('');}).withFailureHandler(e=>offline(e)).apiGetUnitHistory(TOKEN,u,UH_CURRENT_HOURS);}
function renderIncidentAudit(aR){const e=document.getElementById('incAudit');const rs=aR||[];if(!rs.length){e.innerHTML='<div class="muted">NO HISTORY.</div>';return;}e.innerHTML=rs.map(r=>{const ts=r.ts?fmtTime24(r.ts):'‚Äî';const aC=getRoleColor(r.actor);return'<div style="border-bottom:1px solid var(--line); padding:8px 6px;"><div class="muted '+aC+'">'+esc(ts)+' ‚Ä¢ '+esc((r.actor||'').toUpperCase())+'</div><div style="font-weight:900; color:var(--yellow); margin-top:2px;">'+esc(String(r.message||''))+'</div></div>';}).join('');}
function openIncidentFromServer(iId){setLive(true,'LIVE ‚Ä¢ INCIDENT REVIEW');google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);const inc=r.incident;CURRENT_INCIDENT_ID=String(inc.incident_id||'').toUpperCase();document.getElementById('incTitle').textContent='INCIDENT '+CURRENT_INCIDENT_ID;document.getElementById('incUnits').textContent=(inc.units||'‚Äî').toUpperCase();document.getElementById('incDest').textContent=(inc.destination||'‚Äî').toUpperCase();document.getElementById('incUpdated').textContent=inc.last_update?fmtTime24(inc.last_update):'‚Äî';const bC=getRoleColor(inc.updated_by);const bE=document.getElementById('incBy');bE.textContent=(inc.updated_by||'‚Äî').toUpperCase();bE.className=bC;document.getElementById('incNote').value=(inc.incident_note||'').toUpperCase();renderIncidentAudit(r.audit||[]);document.getElementById('incBack').style.display='flex';setTimeout(()=>document.getElementById('incNote').focus(),50);}).withFailureHandler(e=>offline(e)).apiGetIncident(TOKEN,iId);}
function openIncident(iId){openIncidentFromServer(iId);}
function closeIncident(){document.getElementById('incBack').style.display='none';CURRENT_INCIDENT_ID='';}
function saveIncidentNote(){const m=(document.getElementById('incNote').value||'').trim().toUpperCase();if(!CURRENT_INCIDENT_ID)return;if(!m){showConfirm('ERROR','ENTER INCIDENT NOTE.',()=>{});return;}setLive(true,'LIVE ‚Ä¢ ADD NOTE');google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);beepChange();openIncidentFromServer(CURRENT_INCIDENT_ID);refresh();}).withFailureHandler(e=>offline(e)).apiAppendIncidentNote(TOKEN,CURRENT_INCIDENT_ID,m);}
function openMessages(){if(!TOKEN){showConfirm('ERROR','NOT LOGGED IN.',()=>{});return;}const ms=STATE.messages||[];const li=document.getElementById('msgList');document.getElementById('msgModalCount').textContent=ms.length;if(!ms.length){li.innerHTML='<div class="muted" style="padding:20px; text-align:center;">NO MESSAGES</div>';}else{li.innerHTML=ms.map(m=>{const cl=['msgItem'];if(!m.read)cl.push('unread');if(m.urgent)cl.push('urgent');const fr=m.from_initials+'@'+m.from_role;const fC=getRoleColor(fr);const uH=m.urgent?'<div class="msgUrgent">üî• URGENT</div>':'';return'<div class="'+cl.join(' ')+'" onclick="viewMessage(\''+esc(m.message_id)+'\')"><div class="msgHeader"><span class="msgFrom '+fC+'">'+esc(m.message_id)+' ‚Ä¢ FROM '+esc(fr)+'</span><span class="msgTime">'+fmtTime24(m.ts)+'</span></div>'+uH+'<div class="msgText">'+esc(m.message)+'</div></div>';}).join('');}document.getElementById('msgBack').style.display='flex';}
function closeMessages(){document.getElementById('msgBack').style.display='none';refresh();}
function viewMessage(mId){google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);refresh();}).withFailureHandler(e=>offline(e)).apiReadMessage(TOKEN,mId);}
function deleteMessage(mId){google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);beepChange();closeMessages();refresh();}).withFailureHandler(e=>offline(e)).apiDeleteMessage(TOKEN,mId);}
function deleteAllMessages(){google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);beepChange();closeMessages();refresh();}).withFailureHandler(e=>offline(e)).apiDeleteAllMessages(TOKEN);}
function showHelp(){showAlert('HELP - COMMAND REFERENCE','SCMC HOSCAD/EMS TRACKING - COMMAND REFERENCE\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nGENERAL COMMANDS\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nHELP                    Show this help\nSTATUS                  System status summary\nREFRESH                 Reload board data\nINFO                    Show dispatch phone numbers\nWHO                     Show all logged-in users\nUS                      Unit status report (all units)\nLO                      Logout and return to login\n! <TEXT>                Search audit/incidents\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nUNIT OPERATIONS\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n<STATUS> <UNIT>; <NOTE>    Set unit status with note\n<UNIT> <STATUS>; <NOTE>    Alternate syntax\n\nSTATUS CODES: D, DE, OS, F, FD, T, AV, UV, BRK, OOS\n  D   = Pending Dispatch (flashing blue)\n  DE  = Enroute\n  OS  = On Scene\n  F   = Follow Up\n  FD  = Flagged Down\n  T   = Transporting\n  AV  = Available\n  UV  = Unavailable\n  BRK = Break/Lunch\n  OOS = Out of Service\n\nExamples:\n  D JC; MADRAS ED\n  EMS1 OS; ON SCENE\n  F EMS2; FOLLOW UP NEEDED\n  BRK WC1; LUNCH BREAK\n\nLOGON <UNIT>; <NOTE>    Activate unit\nLOGOFF <UNIT>           Deactivate unit\nRIDOFF <UNIT>           Set AV + clear all fields\nLUI                     Open logon modal (empty)\nLUI <UNIT>              Open logon modal (pre-filled)\nUI <UNIT>               Open unit info modal\nUNDO <UNIT>             Undo last action\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nUNIT TIMING (STALE DETECTION)\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nOK <UNIT>               Touch timer (reset staleness)\nOKALL                   Touch all OS units\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nINCIDENT MANAGEMENT\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nNC; <DEST> <NOTE>       Create new incident in queue\n  Example: NC; BEND ED CHEST PAIN\n\nDE <UNIT> <INC>         Assign queued incident to unit\n  Example: DE EMS1 0023\n\nR <INC>                 Review incident + history\n  R 0001 (auto-year) or R INC26-0001\n\nU <INC>; <MESSAGE>      Add note to incident\n  U 0001; PT IN WTG RM\n\nOK INC<ID>              Touch incident timestamp\nLINK <U1> <U2> <INC>    Assign both units to incident\nTRANSFER <FROM> <TO> <INC>   Transfer incident\nCLOSE <INC>             Manually close incident\nRQ <INC>                Reopen incident\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nUNIT HISTORY\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nUH <UNIT> [HOURS]       View unit history\n  UH EMS1 24\n<UNIT> UH [HOURS]       Alternate syntax\n  EMS1 UH 12\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nMASS OPERATIONS\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nMASS D <DEST>           Dispatch all AV units\n  MASS D MADRAS ED\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nBANNERS\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nNOTE; <MESSAGE>         Set info banner\nNOTE; CLEAR             Clear banner\nALERT; <MESSAGE>        Set alert banner (long beep)\nALERT; CLEAR            Clear alert\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nMESSAGING SYSTEM\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nMSG <ROLE>; <TEXT>      Send normal message\n  MSG STA2; NEED COVERAGE AT 1400\n\nHTMSG <ROLE>; <TEXT>    Send URGENT message (hot)\n  HTMSG SUPV1; CALLBACK ASAP\n\nMSGALL; <TEXT>          Broadcast to all active stations\n  MSGALL; RADIO CHECK AT 1400\n\nHTALL; <TEXT>           Urgent broadcast to all\n  HTALL; SEVERE WEATHER WARNING\n\nROLES: STA1-6, SUPV1, SUPV2, EMS, MSC\n\nMSG1, MSG2, MSG3...     Open/view specific message\nDEL MSG1                Delete message 1\nDEL ALL MSG             Delete all your messages\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nUSER MANAGEMENT\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nNEWUSER lastname,firstname   Create new user\n  NEWUSER smith,john ‚Üí creates username smithj\n  (Default password: 12345)\n\nDELUSER <username>      Delete user\n  DELUSER smithj\n\nLISTUSERS               Show all system users\nPASSWD <old> <new>      Change your password\n  PASSWD 12345 myNewPass\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nDATA MANAGEMENT\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nCLEARDATA UNITS         Clear all inactive units\nCLEARDATA AUDIT         Clear audit history\nCLEARDATA INCIDENTS     Clear all incidents\nCLEARDATA ALL           Clear all data (‚ö†Ô∏è CAUTION)\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nKEYBOARD SHORTCUTS\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nCTRL+K / F1 / F3        Focus command bar\nCTRL+L                  Open logon modal\nUP/DOWN ARROWS          Command history\nENTER                   Run command\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nQUICK EXAMPLES\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nD JC; MADRAS ED                    Dispatch\nNC; BEND ED CHEST PAIN             New incident\nDE EMS1 0023                       Assign incident\nF EMS2; FOLLOW UP MADRAS           Follow up\nBRK WC1; LUNCH                     Break\nWHO                                Who is logged in\nUS                                 Unit status report\nMSGALL; RADIO CHECK 1400           Broadcast message\n! MADRAS                           Search for "MADRAS"\nNEWUSER doe,jane                   Create user\nLO                                 Logout',()=>{});}
function runCommand(){const cE=document.getElementById('cmd');let tx=(cE.value||'').trim();if(!tx)return;CMD_HISTORY.push(tx);if(CMD_HISTORY.length>50)CMD_HISTORY.shift();CMD_INDEX=CMD_HISTORY.length;cE.value='';try{_ctx().resume();}catch(e){}if(/^HELP$/i.test(tx))return showHelp();let ma=tx;let no='';const se=tx.indexOf(';');if(se>=0){ma=tx.slice(0,se).trim();no=tx.slice(se+1).trim();}const mU=ma.toUpperCase();const nU=expandShortcutsInText(no||'');if(mU==='LUI'){return openModal(null);}if(mU.startsWith('LUI ')){const uR=ma.substring(4).trim();const uId=canonicalUnit(uR);const dN=displayNameForUnit(uId);const u={unit_id:uId,display_name:dN,type:'',active:true,status:'AV',note:'',unit_info:'',incident:'',destination:'',updated_at:'',updated_by:''};return openModal(u);}if(mU.startsWith('NEWUSER ')){const parts=ma.substring(8).trim().split(',');if(parts.length!==2){showAlert('ERROR','USAGE: NEWUSER lastname,firstname');return;}google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);const collisionMsg=r.collision?'\n\n‚ö†Ô∏è USERNAME COLLISION - NUMBER ADDED':'';showAlert('USER CREATED',`NEW USER CREATED:${collisionMsg}\n\nNAME: ${r.firstName} ${r.lastName}\nUSERNAME: ${r.username}\nPASSWORD: ${r.password}\n\nUser can now log in with this username and password.`);}).withFailureHandler(e=>offline(e)).apiNewUser(TOKEN,parts[0].trim(),parts[1].trim());return;}if(mU.startsWith('DELUSER ')){const u=ma.substring(8).trim();if(!u){showAlert('ERROR','USAGE: DELUSER username');return;}showConfirm('CONFIRM DELETE USER','DELETE USER: '+u+'?',()=>{google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);showAlert('USER DELETED','USER DELETED: '+r.username);}).withFailureHandler(e=>offline(e)).apiDelUser(TOKEN,u);});return;}if(mU.startsWith('REPORTOOS')){const ts=mU.substring(9).trim().toUpperCase();let hrs=24;if(ts){const m=ts.match(/^(\d+)(H|D)$/);if(m){const n=parseInt(m[1]);const ut=m[2];hrs=ut==='D'?n*24:n;}else{showAlert('ERROR','USAGE: REPORTOOS [24H|7D|30D]\nH=HOURS, D=DAYS\nExample: REPORTOOS24H or REPORTOOS7D');return;}}google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);const rp=r.report||{};let out=`OUT OF SERVICE REPORT\n${hrs}H PERIOD (${rp.startTime} TO ${rp.endTime})\n\n`;out+='‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';out+=`TOTAL OOS TIME: ${rp.totalOOSMinutes} MINUTES (${rp.totalOOSHours} HOURS)\n`;out+=`TOTAL UNITS: ${rp.unitCount}\n`;out+='‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';if(rp.units&&rp.units.length>0){out+='UNIT BREAKDOWN:\n\n';rp.units.forEach(u=>{out+=`${u.unit.padEnd(12)} ${String(u.oosMinutes).padStart(6)} MIN  ${u.oosHours} HRS\n`;if(u.periods&&u.periods.length>0){u.periods.forEach(p=>{out+=`  ${p.start} ‚Üí ${p.end} (${p.duration}M)\n`;});}out+='\n';});}else{out+='NO OOS TIME RECORDED IN THIS PERIOD\n';}showAlert('OOS REPORT',out);}).withFailureHandler(e=>offline(e)).apiReportOOS(TOKEN,hrs);return;}if(mU==='CURUSERSINFO'){google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);const users=r.users||[];if(!users.length){showAlert('USER INFO','NO USERS IN SYSTEM');return;}let report='COMPLETE USER INFORMATION\n\n';users.forEach(u=>{report+=`USERNAME: ${u.username}\n`;report+=`NAME: ${u.firstName} ${u.lastName}\n`;report+=`PASSWORD: ${u.password}\n`;report+=`CREATED: ${u.createdAt}\n`;report+=`CREATED BY: ${u.createdBy}\n`;report+=`\n`;});showAlert('ADMIN - USER INFO',report);}).withFailureHandler(e=>offline(e)).apiListUsersAdmin(TOKEN);return;}if(mU.startsWith('REPORTOOS')){const ts=mU.substring(9).trim().toUpperCase();let hrs=24;if(ts){const m=ts.match(/^(\d+)(H|D)$/);if(m){const n=parseInt(m[1]);const ut=m[2];hrs=ut==='D'?n*24:n;}else{showAlert('ERROR','USAGE: REPORTOOS [24H|7D|30D]\nH=HOURS, D=DAYS\nExample: REPORTOOS24H or REPORTOOS7D');return;}}google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);const rp=r.report||{};let out=`OUT OF SERVICE REPORT\n${hrs}H PERIOD (${rp.startTime} TO ${rp.endTime})\n\n`;out+='‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';out+=`TOTAL OOS TIME: ${rp.totalOOSMinutes} MINUTES (${rp.totalOOSHours} HOURS)\n`;out+=`TOTAL UNITS: ${rp.unitCount}\n`;out+='‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';if(rp.units&&rp.units.length>0){out+='UNIT BREAKDOWN:\n\n';rp.units.forEach(u=>{out+=`${u.unit.padEnd(12)} ${String(u.oosMinutes).padStart(6)} MIN  ${u.oosHours} HRS\n`;if(u.periods&&u.periods.length>0){u.periods.forEach(p=>{out+=`  ${p.start} ‚Üí ${p.end} (${p.duration}M)\n`;});}out+='\n';});}else{out+='NO OOS TIME RECORDED IN THIS PERIOD\n';}showAlert('OOS REPORT',out);}).withFailureHandler(e=>offline(e)).apiReportOOS(TOKEN,hrs);return;}if(mU==='CURUSERSINFO'){google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);const users=r.users||[];if(!users.length){showAlert('CURRENT USERS INFO','NO USERS IN SYSTEM');return;}let report='CURRENT USERS - FULL INFO\n\n';users.forEach(u=>{report+=`USERNAME: ${u.username}\n`;report+=`NAME: ${u.firstName} ${u.lastName}\n`;report+=`PASSWORD: ${u.password}\n`;report+=`CREATED: ${fmtTime24(u.createdAt)}\n`;report+=`BY: ${u.createdBy}\n`;report+='‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';});showAlert('CURRENT USERS INFO ('+users.length+')',report);}).withFailureHandler(e=>offline(e)).apiListUsers(TOKEN);return;}if(mU==='WHOCLEAR'){showConfirm('‚ö†Ô∏è CONFIRM CLEAR SESSIONS','CLEAR ALL SESSION HISTORY?\n\nTHIS WILL LOG OUT ALL USERS!\n\nTHIS CANNOT BE UNDONE!',()=>{google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);showAlert('SESSIONS CLEARED',`ALL SESSIONS CLEARED: ${r.deleted} SESSIONS DELETED\n\nALL USERS HAVE BEEN LOGGED OUT.`);}).withFailureHandler(e=>offline(e)).apiClearSessions(TOKEN);});return;}if(mU==='LISTUSERS'){google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);const users=r.users||[];if(!users.length){showAlert('USERS','NO USERS IN SYSTEM');return;}const userList=users.map(u=>`${u.username} - ${u.firstName} ${u.lastName}`).join('\n');showAlert('SYSTEM USERS ('+users.length+')',userList);}).withFailureHandler(e=>offline(e)).apiListUsers(TOKEN);return;}if(mU.startsWith('PASSWD ')){const parts=ma.substring(7).trim().split(/\s+/);if(parts.length!==2){showAlert('ERROR','USAGE: PASSWD oldpassword newpassword');return;}google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);showAlert('PASSWORD CHANGED','YOUR PASSWORD HAS BEEN CHANGED SUCCESSFULLY.');}).withFailureHandler(e=>offline(e)).apiChangePassword(TOKEN,parts[0],parts[1]);return;}if(mU.startsWith('! ')){const query=ma.substring(2).trim().toUpperCase();if(!query||query.length<2){showAlert('ERROR','USAGE: ! searchtext (min 2 chars)');return;}google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);const results=r.results||[];if(!results.length){showAlert('SEARCH RESULTS','NO RESULTS FOUND FOR: '+query);return;}let report='SEARCH RESULTS FOR: '+query+'\n\n';results.forEach(res=>{report+=`[${res.type}] ${res.summary}\n`;});showAlert('SEARCH RESULTS ('+results.length+')',report);}).withFailureHandler(e=>offline(e)).apiSearch(TOKEN,query);return;}if(mU.startsWith('CLEARDATA ')){const what=ma.substring(10).trim().toUpperCase();if(!['UNITS','AUDIT','INCIDENTS','ALL'].includes(what)){showAlert('ERROR','USAGE: CLEARDATA [UNITS|AUDIT|INCIDENTS|ALL]');return;}showConfirm('‚ö†Ô∏è CONFIRM DATA CLEAR',`CLEAR ALL ${what} DATA?\n\nTHIS CANNOT BE UNDONE!`,()=>{google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);showAlert('DATA CLEARED',`${what} DATA CLEARED: ${r.deleted} ROWS DELETED`);refresh();}).withFailureHandler(e=>offline(e)).apiClearData(TOKEN,what);});return;}if(mU==='US'){if(!STATE||!STATE.units){showAlert('ERROR','NO DATA LOADED');return;}const units=(STATE.units||[]).filter(u=>u.active).sort((a,b)=>{const ra=statusRank(a.status);const rb=statusRank(b.status);if(ra!==rb)return ra-rb;return String(a.unit_id||'').localeCompare(String(b.unit_id||''));});let report='UNIT STATUS REPORT\n\n';units.forEach(u=>{const statusLabel=(STATE.statuses||[]).find(s=>s.code===u.status)?.label||u.status;const mins=minutesSince(u.updated_at);const age=mins!=null?Math.floor(mins)+'M':'‚Äî';report+=`${u.unit_id.padEnd(12)} ${u.status.padEnd(4)} ${statusLabel.padEnd(20)} ${age.padEnd(6)}\n`;if(u.incident)report+=`  INC: ${u.incident}\n`;if(u.destination)report+=`  DEST: ${u.destination}\n`;if(u.note)report+=`  NOTE: ${u.note}\n`;});showAlert('UNIT STATUS',report);return;}if(mU==='WHO'){google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);const users=r.users||[];if(!users.length){showAlert('WHO','NO USERS CURRENTLY LOGGED IN');return;}const userList=users.map(u=>`${u.actor} (${u.minutesAgo}M AGO)`).join('\n');showAlert('LOGGED IN USERS',userList);}).withFailureHandler(e=>offline(e)).apiWho(TOKEN);return;}if(mU==='INFO'){showAlert('SCMC HOSCAD INFO','DISPATCH CENTER PHONE NUMBERS:\n\nSTA1: (555) 100-0001\nSTA2: (555) 100-0002\nSTA3: (555) 100-0003\n\nOTHER USEFUL INFO COMING SOON.');return;}if(mU==='STATUS'){google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);const s=r.status;showConfirm('SYSTEM STATUS','SYSTEM STATUS\n\nUNITS: '+s.totalUnits+' TOTAL, '+s.activeUnits+' ACTIVE\n\nBY STATUS:\n  D:   '+(s.byStatus.D||0)+'\n  DE:  '+(s.byStatus.DE||0)+'\n  OS:  '+(s.byStatus.OS||0)+'\n  T:   '+(s.byStatus.T||0)+'\n  AV:  '+(s.byStatus.AV||0)+'\n  OOS: '+(s.byStatus.OOS||0)+'\n\nINCIDENTS:\n  ACTIVE: '+s.activeIncidents+'\n  STALE:  '+s.staleIncidents+'\n\nLOGGED IN AS: '+s.actor,()=>{});}).withFailureHandler(e=>offline(e)).apiGetSystemStatus(TOKEN);return;}if(mU==='OKALL')return okAllOS();if(mU.startsWith('LO ')||mU==='LO'){const targetRole=mU.substring(3).trim().toUpperCase();if(targetRole&&targetRole!==ACTOR.split('@')[1]){showAlert('ERROR','YOU CAN ONLY LOG OUT YOURSELF. YOU ARE '+ACTOR);return;}google.script.run.withSuccessHandler(r=>{localStorage.removeItem('ems_token');TOKEN='';ACTOR='';document.getElementById('loginBack').style.display='flex';document.getElementById('userLabel').textContent='‚Äî';if(POLL)clearInterval(POLL);}).withFailureHandler(e=>{console.error('Logout cleanup failed:',e);localStorage.removeItem('ems_token');TOKEN='';ACTOR='';document.getElementById('loginBack').style.display='flex';document.getElementById('userLabel').textContent='‚Äî';if(POLL)clearInterval(POLL);}).apiLogout(TOKEN);return;}if(mU.startsWith('OK ')){const re=ma.substring(3).trim().toUpperCase();if(re.startsWith('INC')){const iId=re.replace(/^INC\s*/i,'');google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);beepChange();refresh();}).withFailureHandler(e=>offline(e)).apiTouchIncident(TOKEN,iId);return;}const u=canonicalUnit(re);if(!u){showConfirm('ERROR','USAGE: OK <UNIT> OR OK INC0001',()=>{});return;}const uO=(STATE&&STATE.units)?STATE.units.find(x=>String(x.unit_id||'').toUpperCase()===u):null;if(!uO){showConfirm('ERROR','UNIT NOT FOUND: '+u,()=>{});return;}return okUnit(uO);}if(mU==='NOTE'){setLive(true,'LIVE ‚Ä¢ NOTE');return google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);beepNote();refresh();}).withFailureHandler(e=>offline(e)).apiSetBanner(TOKEN,'NOTE',nU||'CLEAR');}if(mU==='ALERT'){setLive(true,'LIVE ‚Ä¢ ALERT');return google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);beepAlert();refresh();}).withFailureHandler(e=>offline(e)).apiSetBanner(TOKEN,'ALERT',nU||'CLEAR');}if(mU.startsWith('UI ')){const u=canonicalUnit(ma.substring(3).trim());if(!u){showConfirm('ERROR','USAGE: UI <UNIT>',()=>{});return;}const uO=(STATE&&STATE.units)?STATE.units.find(x=>String(x.unit_id||'').toUpperCase()===u):null;if(uO)openModal(uO,true);else openModal({unit_id:u,display_name:displayNameForUnit(u),type:'',active:true,status:'AV',note:'',unit_info:'',incident:'',destination:'',updated_at:'',updated_by:''},true);return;}if(mU.startsWith('INFO ')){const u=canonicalUnit(ma.substring(5).trim());if(!u){showConfirm('ERROR','USAGE: INFO <UNIT>',()=>{});return;}google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);const un=r.unit;showConfirm('UNIT INFO: '+un.unit_id,'UNIT INFO: '+un.unit_id+'\n\nDISPLAY: '+(un.display_name||'‚Äî')+'\nTYPE: '+(un.type||'‚Äî')+'\nSTATUS: '+(un.status||'‚Äî')+'\nACTIVE: '+(un.active?'YES':'NO')+'\n\nINCIDENT: '+(un.incident||'‚Äî')+'\nDESTINATION: '+(un.destination||'‚Äî')+'\nNOTE: '+(un.note||'‚Äî')+'\n\nUNIT INFO:\n'+(un.unit_info||'(NONE)')+'\n\nUPDATED: '+(un.updated_at||'‚Äî')+'\nBY: '+(un.updated_by||'‚Äî'),()=>{});}).withFailureHandler(e=>offline(e)).apiGetUnitInfo(TOKEN,u);return;}if(mU.startsWith('R ')){const iR=ma.substring(2).trim().toUpperCase();if(!iR){showConfirm('ERROR','USAGE: R INC0001 OR R 0001',()=>{});return;}return openIncidentFromServer(iR);}if(mU.startsWith('U ')){const iR=ma.substring(2).trim().toUpperCase();if(!iR){showConfirm('ERROR','USAGE: U INC0001; MESSAGE',()=>{});return;}if(!nU){showConfirm('ERROR','USAGE: U INC0001; MESSAGE (MESSAGE REQUIRED)',()=>{});return;}setLive(true,'LIVE ‚Ä¢ ADD NOTE');return google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);beepChange();refresh();}).withFailureHandler(e=>offline(e)).apiAppendIncidentNote(TOKEN,iR,nU);}if(mU.startsWith('LINK ')){const ps=ma.substring(5).trim().split(/\s+/);if(ps.length<3){showConfirm('ERROR','USAGE: LINK UNIT1 UNIT2 INC0001',()=>{});return;}const inc=ps[ps.length-1].toUpperCase();const u2R=ps[ps.length-2];const u1R=ps.slice(0,-2).join(' ');const u1=canonicalUnit(u1R);const u2=canonicalUnit(u2R);if(!u1||!u2){showConfirm('ERROR','USAGE: LINK UNIT1 UNIT2 INC0001',()=>{});return;}google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);beepChange();refresh();}).withFailureHandler(e=>offline(e)).apiLinkUnits(TOKEN,u1,u2,inc);return;}if(mU.startsWith('TRANSFER ')){const ps=ma.substring(9).trim().split(/\s+/);if(ps.length<3){showConfirm('ERROR','USAGE: TRANSFER UNIT1 UNIT2 INC0001',()=>{});return;}const inc=ps[ps.length-1].toUpperCase();const u2R=ps[ps.length-2];const u1R=ps.slice(0,-2).join(' ');const u1=canonicalUnit(u1R);const u2=canonicalUnit(u2R);if(!u1||!u2){showConfirm('ERROR','USAGE: TRANSFER UNIT1 UNIT2 INC0001',()=>{});return;}google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);beepChange();refresh();}).withFailureHandler(e=>offline(e)).apiTransferIncident(TOKEN,u1,u2,inc);return;}if(mU.startsWith('CLOSE ')){const inc=ma.substring(6).trim().toUpperCase();if(!inc){showConfirm('ERROR','USAGE: CLOSE INC0001',()=>{});return;}google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);beepChange();refresh();}).withFailureHandler(e=>offline(e)).apiCloseIncident(TOKEN,inc);return;}if(mU.startsWith('RQ ')){const inc=ma.substring(3).trim().toUpperCase();if(!inc){showConfirm('ERROR','USAGE: RQ INC0001',()=>{});return;}google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);beepChange();refresh();}).withFailureHandler(e=>offline(e)).apiReopenIncident(TOKEN,inc);return;}if(mU.startsWith('MASS D ')){const de=ma.substring(7).trim().toUpperCase();if(!de){showConfirm('ERROR','USAGE: MASS D <DESTINATION>',()=>{});return;}showConfirm('CONFIRM MASS DISPATCH','MASS DISPATCH ALL AV UNITS TO '+de+'?',()=>{google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);const ct=(r.updated||[]).length;showConfirm('MASS DISPATCH COMPLETE','MASS DISPATCH: '+ct+' UNITS DISPATCHED TO '+de+'\n\n'+(r.updated||[]).join(', '),()=>{});beepChange();refresh();}).withFailureHandler(e=>offline(e)).apiMassDispatch(TOKEN,de);});return;}if(mU.startsWith('UH ')){const ps=ma.trim().split(/\s+/);let hr=12;const la=ps[ps.length-1];if(/^\d+$/.test(la)){hr=Number(la);ps.pop();}const uR=ps.slice(1).join(' ').trim();const u=canonicalUnit(uR);if(!u){showConfirm('ERROR','USAGE: UH <UNIT> [12|24|48|168]',()=>{});return;}return openHistory(u,hr);}{const ps=ma.trim().split(/\s+/).filter(Boolean);if(ps.length>=2&&ps[1].toUpperCase()==='UH'){let hr=12;const la=ps[ps.length-1];const hH=/^\d+$/.test(la);if(hH)hr=Number(la);const en=hH?ps.length-1:ps.length;const uR=ps.slice(0,en).filter((x,i)=>i!==1).join(' ');const u=canonicalUnit(uR);if(!u){showConfirm('ERROR','USAGE: <UNIT> UH [12|24|48|168]',()=>{});return;}return openHistory(u,hr);}}if(mU.startsWith('UNDO ')){const u=canonicalUnit(ma.substring(5).trim());if(!u){showConfirm('ERROR','USAGE: UNDO <UNIT>',()=>{});return;}return undoUnit(u);}if(mU.startsWith('LOGON ')){const u=canonicalUnit(ma.substring(6).trim());if(!u){showConfirm('ERROR','USAGE: LOGON <UNIT>; <NOTE>',()=>{});return;}const dN=displayNameForUnit(u);setLive(true,'LIVE ‚Ä¢ LOGON');return google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);beepChange();refresh();}).withFailureHandler(e=>offline(e)).apiUpsertUnit(TOKEN,u,{active:true,status:'AV',note:nU,displayName:dN},'');}if(mU.startsWith('LOGOFF ')){const u=canonicalUnit(ma.substring(7).trim());if(!u){showConfirm('ERROR','USAGE: LOGOFF <UNIT>',()=>{});return;}const uO=(STATE&&STATE.units)?STATE.units.find(x=>String(x.unit_id||'').toUpperCase()===u):null;const currentStatus=uO?uO.status:'';const needsConfirm=['OS','T','D','DE'].includes(currentStatus);if(needsConfirm){showConfirm('CONFIRM LOGOFF','LOGOFF '+u+' (CURRENTLY '+currentStatus+')?',()=>{setLive(true,'LIVE ‚Ä¢ LOGOFF');return google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);beepChange();refresh();}).withFailureHandler(e=>offline(e)).apiLogoffUnit(TOKEN,u,'');});}else{setLive(true,'LIVE ‚Ä¢ LOGOFF');return google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);beepChange();refresh();}).withFailureHandler(e=>offline(e)).apiLogoffUnit(TOKEN,u,'');}return;}if(mU.startsWith('RIDOFF ')){const u=canonicalUnit(ma.substring(7).trim());if(!u){showConfirm('ERROR','USAGE: RIDOFF <UNIT>',()=>{});return;}showConfirm('CONFIRM RIDOFF','RIDOFF '+u+'? (SETS AV + CLEARS NOTE/INC/DEST)',()=>{setLive(true,'LIVE ‚Ä¢ RIDOFF');return google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);beepChange();refresh();}).withFailureHandler(e=>offline(e)).apiRidoffUnit(TOKEN,u,'');});return;}if(mU==='NC'){if(!nU){showAlert('ERROR','USAGE: NC; DESTINATION (NOTE OPTIONAL)');return;}const parts=nU.split(/\s+/);const dest=parts[0];const note=parts.slice(1).join(' ')||'';setLive(true,'LIVE ‚Ä¢ CREATE INCIDENT');google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);beepChange();refresh();autoFocusCmd();}).withFailureHandler(e=>offline(e)).apiCreateQueuedIncident(TOKEN,dest,note,false,'');return;}if(mU==='MSGALL'){if(!nU){showAlert('ERROR','USAGE: MSGALL; MESSAGE TEXT');return;}google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);showAlert('MESSAGE SENT',`BROADCAST MESSAGE SENT TO ${r.recipients} RECIPIENTS`);beepChange();refresh();}).withFailureHandler(e=>offline(e)).apiSendBroadcast(TOKEN,nU,false);return;}if(mU==='HTALL'){if(!nU){showAlert('ERROR','USAGE: HTALL; URGENT MESSAGE TEXT');return;}google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);showAlert('URGENT MESSAGE SENT',`URGENT BROADCAST SENT TO ${r.recipients} RECIPIENTS`);beepHotMessage();refresh();}).withFailureHandler(e=>offline(e)).apiSendBroadcast(TOKEN,nU,true);return;}if(mU.startsWith('MSG ')){const tR=ma.substring(4).trim().toUpperCase();if(!tR||!nU){showAlert('ERROR','USAGE: MSG STA2; MESSAGE TEXT');return;}google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);beepChange();refresh();}).withFailureHandler(e=>offline(e)).apiSendMessage(TOKEN,tR,nU,false);return;}if(mU.startsWith('HTMSG ')){const tR=ma.substring(6).trim().toUpperCase();if(!tR||!nU){showConfirm('ERROR','USAGE: HTMSG STA2; URGENT MESSAGE',()=>{});return;}google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);beepHotMessage();refresh();}).withFailureHandler(e=>offline(e)).apiSendMessage(TOKEN,tR,nU,true);return;}if(/^MSG\d+$/i.test(mU)){return viewMessage(mU);}if(mU.startsWith('DEL ALL MSG')){return deleteAllMessages();}if(mU.startsWith('DEL MSG')){const re=mU.substring(7).trim();if(!re){showConfirm('ERROR','USAGE: DEL MSG1 OR DEL ALL MSG',()=>{});return;}const msgId=re.toUpperCase();if(/^MSG\d+$/i.test(msgId)||/^\d+$/.test(re)){const finalId=/^\d+$/.test(re)?'MSG'+re:msgId;return deleteMessage(finalId);}showConfirm('ERROR','USAGE: DEL MSG1 OR DEL ALL MSG',()=>{});return;}const tk=ma.trim().split(/\s+/).filter(Boolean);const vS=new Set(['D','DE','OS','F','FD','T','AV','UV','BRK','OOS']);function parseStatusUnit(t){if(t.length>=2&&vS.has(t[0].toUpperCase())){return{status:t[0].toUpperCase(),unit:t.slice(1).join(' ')};}if(t.length>=2&&vS.has(t[t.length-1].toUpperCase())){return{status:t[t.length-1].toUpperCase(),unit:t.slice(0,-1).join(' ')};}if(t.length===2&&vS.has(t[1].toUpperCase())){return{status:t[1].toUpperCase(),unit:t[0]};}if(t.length===3&&vS.has(t[0].toUpperCase())){return{status:t[0].toUpperCase(),unit:t.slice(1).join(' ')};}return null;}const pa=parseStatusUnit(tk);if(!pa){showAlert('ERROR','UNKNOWN COMMAND. TYPE HELP FOR ALL COMMANDS.');return;}const st=pa.status;let rawUnit=pa.unit;let incidentId='';const incMatch=rawUnit.match(/\s+(INC\s*\d{2}-\d{4}|INC\s*\d{4}|\d{2}-\d{4}|\d{4})$/i);if(incMatch){incidentId=incMatch[1].replace(/^INC\s*/i,'').trim().toUpperCase();if(/^\d{4}$/.test(incidentId)){const year=new Date().getFullYear();const yy=String(year).slice(-2);incidentId=yy+'-'+incidentId;}rawUnit=rawUnit.substring(0,incMatch.index).trim();}const u=canonicalUnit(rawUnit);const dN=displayNameForUnit(u);const p={status:st,displayName:dN};if(nU)p.note=nU;if(incidentId){p.incident=incidentId;}setLive(true,'LIVE ‚Ä¢ UPDATE');return google.script.run.withSuccessHandler(r=>{if(!r.ok)return showErr(r);beepChange();refresh();autoFocusCmd();}).withFailureHandler(e=>offline(e)).apiUpsertUnit(TOKEN,u,p,'');}
function renderBoard(){const tb=document.getElementById('boardBody');const q=document.getElementById('search').value.trim().toUpperCase();const sI=document.getElementById('showInactive').checked;let us=(STATE.units||[]).filter(u=>{if(!sI&&!u.active)return false;const h=(u.unit_id+' '+(u.display_name||'')+' '+(u.note||'')+' '+(u.destination||'')+' '+(u.incident||'')).toUpperCase();if(q&&!h.includes(q))return false;if(ACTIVE_INCIDENT_FILTER&&String(u.incident||'')!==ACTIVE_INCIDENT_FILTER)return false;return true;});us.sort((a,b)=>{const ra=statusRank(a.status);const rb=statusRank(b.status);if(ra!==rb)return ra-rb;if(String(a.status||'').toUpperCase()==='D'){const ta=a.updated_at?new Date(a.updated_at).getTime():0;const tb=b.updated_at?new Date(b.updated_at).getTime():0;return tb-ta;}return String(a.unit_id||'').localeCompare(String(b.unit_id||''));});const st=[];us.forEach(u=>{if(!u.active)return;if(String(u.status||'').toUpperCase()!=='OS')return;const mi=minutesSince(u.updated_at);if(mi!=null&&mi>=STATE.staleThresholds.CRITICAL)st.push(u.unit_id);});const ba=document.getElementById('staleBanner');if(st.length){ba.style.display='block';ba.textContent='STALE ON SCENE (‚â• '+STATE.staleThresholds.CRITICAL+'M): '+st.join(', ');}else{ba.style.display='none';}tb.innerHTML='';us.forEach(u=>{const tr=document.createElement('tr');const mi=minutesSince(u.updated_at);if(u.active&&String(u.status||'').toUpperCase()==='OS'&&mi!=null){if(mi>=STATE.staleThresholds.CRITICAL)tr.classList.add('stale30');else if(mi>=STATE.staleThresholds.ALERT)tr.classList.add('stale20');else if(mi>=STATE.staleThresholds.WARN)tr.classList.add('stale10');}const sL=(STATE.statuses||[]).find(s=>s.code===u.status)?.label||u.status;const sH='<div class="statusPill S-'+esc(u.status)+'"><div class="statusTop">'+esc(u.status)+' ‚Äî '+esc(sL)+'</div><div class="statusMeta">'+(u.incident?'INC '+esc(u.incident):'NO INCIDENT')+(mi!=null?' ‚Ä¢ '+Math.floor(mi)+'M':'')+'</div></div>';const de=(u.destination||'').toUpperCase();const nt=(u.note||'').toUpperCase();const nH='<div class="destBig">'+esc(de||'‚Äî')+'</div><div class="noteBig">'+esc(nt||'')+'</div>';const aC=getRoleColor(u.updated_by);const uH='<div>'+fmtTime24(u.updated_at)+'</div><div class="muted '+aC+'">'+esc((u.updated_by||'').toUpperCase())+'</div>';const uId=(u.unit_id||'').toUpperCase();const di=(u.display_name||'').toUpperCase();const sD=di&&di!==uId;const unH='<div class="unit">'+esc(uId)+(u.active?'':' <span class="muted">(INACTIVE)</span>')+'</div>'+(sD?'<div class="muted">'+esc(di)+'</div>':'');const ac=document.createElement('div');ac.className='actions';['D','DE','OS','T','AV','OOS'].forEach(c=>{const b=document.createElement('button');b.className='mini btn-secondary';b.textContent=c;b.onclick=()=>quickStatus(u,c);ac.appendChild(b);});if(u.active&&String(u.status||'').toUpperCase()==='OS'){const oB=document.createElement('button');oB.className='mini btn-good';oB.textContent='OK';oB.onclick=()=>okUnit(u);ac.appendChild(oB);}const ed=document.createElement('button');ed.className='mini btn-secondary';ed.textContent='EDIT';ed.onclick=()=>openModal(u);ac.appendChild(ed);const ui=document.createElement('button');ui.className='mini btn-secondary';ui.textContent='INFO';ui.onclick=()=>openModal(u,true);ac.appendChild(ui);const hs=document.createElement('button');hs.className='mini btn-secondary';hs.textContent='UH';hs.onclick=()=>openHistory(u.unit_id,12);ac.appendChild(hs);const un=document.createElement('button');un.className='mini btn-secondary';un.textContent='UNDO';un.onclick=()=>undoUnit(u.unit_id);ac.appendChild(un);tr.innerHTML='<td>'+unH+'</td><td>'+sH+'</td><td>'+nH+'</td><td>'+uH+'</td><td></td>';tr.querySelector('td:last-child').appendChild(ac);tr.onclick=(e)=>{if(e.target.tagName==='BUTTON')return;openModal(u);};tb.appendChild(tr);});}
function renderMetrics(){const el=document.getElementById('metrics');const m=STATE.metrics||{};const av=m.averagesMinutes||{};const ls=[];ls.push('<div>D‚ÜíDE AVG: <b>'+(av['D‚ÜíDE']??'‚Äî')+'</b> MIN</div>');ls.push('<div>DE‚ÜíOS AVG: <b>'+(av['DE‚ÜíOS']??'‚Äî')+'</b> MIN</div>');ls.push('<div>OS‚ÜíT  AVG: <b>'+(av['OS‚ÜíT']??'‚Äî')+'</b> MIN</div>');ls.push('<div>T‚ÜíAV  AVG: <b>'+(av['T‚ÜíAV']??'‚Äî')+'</b> MIN</div>');if(m.longestCurrentlyOnScene){ls.push('<div style="margin-top:8px;">LONGEST ON SCENE: <b>'+m.longestCurrentlyOnScene.unit+'</b> ('+m.longestCurrentlyOnScene.minutes+'M)</div>');}el.innerHTML=ls.join('');}
function start(){google.script.run.withSuccessHandler(()=>{refresh();if(POLL)clearInterval(POLL);POLL=setInterval(refresh,10000);document.getElementById('search').addEventListener('input',renderBoard);document.getElementById('showInactive').addEventListener('change',renderBoard);}).withFailureHandler(e=>offline(e)).apiInit();}
window.addEventListener('load',()=>{document.getElementById('loginRole').value='';document.getElementById('loginUsername').value='';document.getElementById('loginPassword').value='';document.getElementById('loginRole').addEventListener('change',(e)=>{const isUnit=e.target.value==='UNIT';document.getElementById('loginPasswordRow').style.display=isUnit?'none':'flex';if(isUnit)document.getElementById('loginPassword').value='';});document.getElementById('loginRole').addEventListener('keydown',(e)=>{if(e.key==='Enter')document.getElementById('loginUsername').focus();});document.getElementById('loginUsername').addEventListener('keydown',(e)=>{if(e.key==='Enter'){if(document.getElementById('loginRole').value==='UNIT'){login();}else{document.getElementById('loginPassword').focus();}}});document.getElementById('loginPassword').addEventListener('keydown',(e)=>{if(e.key==='Enter')login();});const cI=document.getElementById('cmd');cI.addEventListener('keydown',(e)=>{if(e.key==='Enter'){runCommand();}else if(e.key==='ArrowUp'){e.preventDefault();if(CMD_INDEX>0){CMD_INDEX--;cI.value=CMD_HISTORY[CMD_INDEX]||'';}}else if(e.key==='ArrowDown'){e.preventDefault();if(CMD_INDEX<CMD_HISTORY.length-1){CMD_INDEX++;cI.value=CMD_HISTORY[CMD_INDEX]||'';}else{CMD_INDEX=CMD_HISTORY.length;cI.value='';}}});document.addEventListener('keydown',(e)=>{if(e.key==='Escape'){const nib=document.getElementById('newIncBack');const uhb=document.getElementById('uhBack');const ib=document.getElementById('incBack');const mb=document.getElementById('modalBack');const cd=document.getElementById('confirmDialog');const ad=document.getElementById('alertDialog');if(nib&&nib.classList.contains('active')){closeNewIncident();return;}if(uhb&&uhb.style.display==='flex'){uhb.style.display='none';autoFocusCmd();return;}if(ib&&ib.style.display==='flex'){ib.style.display='none';autoFocusCmd();return;}if(mb&&mb.style.display==='flex'){closeModal();return;}if(cd&&cd.classList.contains('active')){hideConfirm();return;}if(ad&&ad.classList.contains('active')){hideAlert();return;}}if(e.ctrlKey&&e.key==='k'){e.preventDefault();cI.focus();}if(e.ctrlKey&&e.key==='l'){e.preventDefault();openLogon();}if(e.key==='F1'){e.preventDefault();cI.focus();}if(e.key==='F3'){e.preventDefault();cI.focus();}});document.getElementById('loginBack').style.display='flex';document.getElementById('userLabel').textContent='‚Äî';});
</script>
</body>
</html>